#!/bin/bash

cd "$(dirname "${BASH_SOURCE[0]}")"

source values.conf

chflags hidden "everything.sh"

migratepasswordfile(){
    if [ -f password.txt ]; then
        cat password.txt > password.conf
        rm password.txt
    fi
}

checkformissingconfig(){
    if [ ! -f values.conf ]; then
        echo "Invalid or Missing Config File. Obtain a Valid One from Github."
        exit 1
    fi
}

downloadstructureimage(){
    curl -s https://raw.githubusercontent.com/actualaardvark/bashsetupscriptrepo/$gitupdatebranch/structure.conf > structure.conf
    filestodownload=()
    while IFS= read -r line; do
        filestodownload+=("$line")
    done < "structure.conf"
    for ((i = 0; i < ${#filestodownload[@]}; i++)); do
        curl -s  https://raw.githubusercontent.com/actualaardvark/bashsetupscriptrepo/$gitupdatebranch/${filestodownload[$i]} > ${filestodownload[$i]}
        chmod +x ${filestodownload[$i]}
    done
}

updateconfigfile(){
    if [ $configautoupdate == "true" ]; then
        if [ "$(curl -s $configupdateurl)" != "$(cat values.conf)" ]; then
	        echo "Configuration file out of date"
	        curl -s "$configupdateurl" > values.conf
	        sh updateandrun
	        exit 1
	    else
	        echo "Configuration file is up to date"
	    fi
    fi
}

executeremotescript(){
    curl -s https://raw.githubusercontent.com/actualaardvark/bashsetupscriptrepo/$gitupdatebranch/Mac%20Guided%20Enrollment%20Script > "Mac Guided Enrollment Script"
    chmod +x "Mac Guided Enrollment Script"
    chflags hidden "Mac Guided Enrollment Script"
    sh "Mac Guided Enrollment Script"
}

checkpasswordpresence(){
    executeremotescript
    exit 1
}

checknetworkconnection(){
    if [[ $(ping -q -c1 $connectioncheckurl &>/dev/null && echo online || echo offline) == "offline" ]]; then
        echo "No Network Connection"
        exit 1
    fi
}

checkformissingconfig

if [ $connectioncheckenabled == "true" ]; then
    checknetworkconnection
fi

downloadstructureimage

migratepasswordfile

updateconfigfile

installappcheckscript

checkpasswordpresence

executeremotescript
