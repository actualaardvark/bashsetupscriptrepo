#!/bin/bash
curl https://raw.githubusercontent.com/actualaardvark/bashsetupscriptrepo/main/updateandrun > updateandrun.sh

full_name=$(dscl . -read /Users/$(id -un 502) RealName | awk -F': ' '{print $2}')
level = ${full_name:0:3}

oldupdater=$(shasum -a 256 /volumes/"Install macOS Ventura"/updateandrun)
newupdater=$(shasum -a 256 updateandrun.sh)
oldupdaterhash=${oldupdater%% *}
newupdaterhash=${newupdater%% *}

if [ "$oldupdaterhash" != "$newupdaterhash" ]; then
	echo "Updater out of date"
	cat updateandrun.sh > /volumes/"Install macOS Ventura"/updateandrun
	chmod +x /volumes/"install MacOS ventura"/updateandrun
	rm updateandrun.sh
	osascript -e 'display notification "Updater out of date" with title "Restarting Script"'
	sh /volumes/"install MacOS ventura"/updateandrun
	exit 1
else
	echo "Updater is on the latest version"
fi

if [ $(whoami) != '_applecore' ]; then
	osascript -e 'display dialog "Login as _applecore to run this script"'
	exit 1
fi

# Define checklist items
checklist=("Username Check" "Network Rename" "Device Rename" "Computer
Rename" "Script Wrap-Up")
checklist_status=(0 0 0 0 0)

# Loop through checklist items and display them with checkboxes
checklistrender () {
        clear
        for ((i=0; i<${#checklist[@]}; i++)); do
            if [[ ${checklist_status[$i]} -eq 1 ]]; then
                checkbox="[x]"
            else
                checkbox="[ ]"
            fi
            echo "$checkbox ${checklist[$i]}"
        done
}

if [ $(whoami) != '_applecore' ]; then
	osascript -e 'display dialog "Login as _applecore to run this script"'
	exit 1
fi

checklist_status=(1 0 0 0 0)
checklistrender

# Get the full name of the logged-in account
osascript -e 'display notification "Applying JAMF naming convention..." with title "Script Progress"'

# Set HostName, ComputerName, and LocalHostName to the full name
sudo scutil --set HostName "$full_name"

checklist_status=(1 1 0 0 0)
checklistrender

sudo scutil --set ComputerName "$full_name"
checklist_status=(1 1 1 0 0)
checklistrender
sudo scutil --set LocalHostName "$full_name"
checklist_status=(1 1 1 1 0)
checklistrender


osascript -e 'display notification "Naming convention updated" with title "Script Progress"'

# Run the command to renew enrollment
osascript -e 'display notification "Beginning user enrollment..." with title "Script Progress"'
sudo profiles renew -type enrollment

osascript -e 'display notification "User enrollment complete" with title "Script Progress"'

osascript -e 'display dialog "Script execution complete"'

checklist_status=(1 1 1 1 1)

checklistrender
if [ "$level" = "NLS" ]; then
	sudo dseditgroup -o edit -d $(id -un 502) -t user admin
fi
if [ "$level" = "NMS" ]; then
	sudo dseditgroup -o edit -d $(id -un 502) -t user admin
fi